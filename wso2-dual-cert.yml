---
  # This is not a complete playbook, it's a part that was extracted from the other,
  # I may or may not merge it back, depending on how important is having a working dashboard
  # (see wso2.yml for details)

  # Also, edit these lines in catalina-server.xml:
  # keystoreFile="${carbon.home}/repository/resources/security/tls.jks"
  # keystorePass="tlstlstls"

  # Created like this:
  # cd /usr/lib64/wso2/wso2is/5.7.0/repository/resources/security/
  # keytool -genkeypair -keystore tls.jks -dname "CN=wso2.sso.local, OU=Whatever, O=Example, C=US" -keypass tlstlstls -storepass tlstlstls -keyalg RSA -alias tls
  # keytool -export -alias tls -file tls.cer -keystore tls.jks -storepass tlstlstls
  # keytool -importkeystore -srckeystore tls.jks -destkeystore tls.p12 -srcstoretype JKS -deststoretype PKCS12 -srckeypass tlstlstls -srcstorepass tlstlstls -deststorepass tlstlstls -srcalias tls -destalias tls
  #
  # TODO: the CN part apparently is validated by clients. This makes no sense.
  #
  # keytool -genkeypair -keystore wso2carbon.jks -dname "CN=wso2.sso.local,OU=Signing certificate,O=Example,C=US" -keypass wso2carbon -storepass wso2carbon -keyalg RSA -validity 3650 -alias wso2carbon
  # keytool -export -file wso2carbon.cer -keystore wso2carbon.jks -storepass wso2carbon -alias wso2carbon
  # keytool -importcert -file wso2carbon.cer -keystore client-truststore.jks -storepass wso2carbon -alias wso2carbon
  # keytool -importkeystore -srckeystore wso2carbon.jks -destkeystore wso2carbon.p12 -srcstoretype JKS -deststoretype PKCS12 -srcstorepass wso2carbon -deststorepass wso2carbon -srcalias wso2carbon -destalias wso2carbon
  #
  # May be useful for SAML configuration and stuff:
  # openssl x509 -in wso2carbon.cer -inform der -outform pem -out wso2carbon.pem
  - name: Copy .p12 + .cer to the server
    copy:
      src: "wso2/{{ item }}"
      dest: "/usr/lib64/wso2/wso2is/{{ wso2is_version }}/repository/resources/security/"
      owner: root
      group: wso2
      mode: 0640
      setype: cert_t
    become: true
    loop:
      - tls.p12
      - tls.cer
      - wso2carbon.p12
      - wso2carbon.cer

  - name: Check if default certificate is in keystore
    shell: "keytool -list -v -keystore /usr/lib64/wso2/wso2is/{{ wso2is_version }}/repository/resources/security/wso2carbon.jks -storepass wso2carbon -keypass wso2carbon -alias wso2carbon | grep localhost"
    become: true
    register: wso2is_keystore_grep
    failed_when: "'rc' not in wso2is_keystore_grep or wso2is_keystore_grep.rc|int > 1 or wso2is_keystore_grep.rc|int < 0"
    changed_when: false

  - name: Remove default keystore
    file:
      path: "/usr/lib64/wso2/wso2is/{{ wso2is_version }}/repository/resources/security/wso2carbon.jks"
      state: absent
    become: true
    when: wso2is_keystore_grep.rc|int == 0

  - name: Update wso2carbon keystore
    java_cert:
      pkcs12_path: "/usr/lib64/wso2/wso2is/{{ wso2is_version }}/repository/resources/security/wso2carbon.p12"
      cert_alias: wso2carbon
      keystore_path: "/usr/lib64/wso2/wso2is/{{ wso2is_version }}/repository/resources/security/wso2carbon.jks"
      keystore_pass: wso2carbon
      pkcs12_password: wso2carbon
      pkcs12_alias: wso2carbon
      keystore_create: true
      state: present
    become: true
    notify: restart WSO2IS

  - name: Update tls keystore
    java_cert:
      pkcs12_path: "/usr/lib64/wso2/wso2is/{{ wso2is_version }}/repository/resources/security/tls.p12"
      cert_alias: tls
      keystore_path: "/usr/lib64/wso2/wso2is/{{ wso2is_version }}/repository/resources/security/tls.jks"
      keystore_pass: tlstlstls
      pkcs12_password: tlstlstls
      pkcs12_alias: tls
      keystore_create: true
      state: present
    become: true
    notify: restart WSO2IS

  - name: Change keystores permissions
    file:
      path: "/usr/lib64/wso2/wso2is/{{ wso2is_version }}/repository/resources/security/{{ item }}"
      state: file
      owner: root
      group: wso2
      mode: 0640
      setype: cert_t
    loop:
      - tls.cer
      - wso2carbon.cer
    become: true

  - name: Trust our certificates
    java_cert:
      cert_path: "/usr/lib64/wso2/wso2is/{{ wso2is_version }}/repository/resources/security/{{ item }}"
      cert_alias: wso2carbon
      keystore_path: "/usr/lib64/wso2/wso2is/{{ wso2is_version }}/repository/resources/security/client-truststore.jks"
      keystore_pass: wso2carbon
      keystore_create: false
      state: present
    loop:
      - tls.cer
      - wso2carbon.cer
    become: true
    notify: restart WSO2IS
